#include "common.h"
#include "exact-merge.h"

// load data from rcpp_exact_initial into the EXMerge struct
void rcpp_exmerge_init (const Rcpp::DataFrame &gr, EXMerge &cldat)
{
    Rcpp::IntegerVector from = gr ["from"];
    Rcpp::IntegerVector to = gr ["to"];
    Rcpp::NumericVector d = gr ["d"];
    Rcpp::IntegerVector clnum = gr ["cl"];
    Rcpp::IntegerVector clfrom = gr ["cl_from"];
    Rcpp::IntegerVector clto = gr ["cl_to"];

    const int n = d.size ();
    
    cldat.edges.resize (n);
    std::unordered_map <int, std::unordered_set <int> > cl2edge_map;
    // The EXMerge struct has a set of inter-cluster edges which are filled
    // here; the rest of the struct is filled below
    for (int i = 0; i < n; i++)
    {
        if (clnum [i] >= 0) // edge in a cluster
        {
            std::unordered_set <int> edgeset;
            if (cl2edge_map.find (clnum [i]) != cl2edge_map.end ())
                edgeset = cl2edge_map.at (clnum [i]);
            edgeset.emplace (i);
            cl2edge_map [clnum [i]] = edgeset;
        } else // fill inter-cluster edge
        {
            OneEdge edgei;
            edgei.from = clfrom [i];
            edgei.to = clto [i];
            edgei.dist = d [i];
            cldat.edges [i] = edgei;
        }
    }

    // Fill intra-cluster data:
    const int ncl = cl2edge_map.size ();
    cldat.clusters.resize (ncl);
    for (int i = 0; i < ncl; i++)
    {
        OneCluster cli;
        std::unordered_set <int> edgeset = cl2edge_map.at (i);
        cli.id = i;
        cli.n = edgeset.size ();
        cli.dist_sum = 0.0;
        cli.dist_max = 0.0;
        for (auto ei: edgeset)
        {
            cli.dist_sum += ei;
            if (ei > cli.dist_max)
                cli.dist_max = ei;
        }
        cldat.clusters [i] = cli;
    }
}

void rcpp_exmerge_single (EXMerge &cldat)
{
}

void rcpp_exmerge_avg (EXMerge &cldat)
{
}

void rcpp_exmerge_max (EXMerge &cldat)
{
}



//' rcpp_exact_merge
//'
//' Merge clusters generated by rcpp_exact_initial to obtain specified number of
//' clusters.
//'
//' @noRd
// [[Rcpp::export]]
Rcpp::IntegerVector rcpp_exact_merge (
        const Rcpp::DataFrame gr,
        const int ncl,
        const std::string method)
{
    EXMerge clmerge_dat;
    rcpp_exmerge_init (gr, clmerge_dat);

    if (strfound (method, "single")) // strfound from utils.cpp
    {
    } else if (strfound (method, "average"))
    {
    } else if (strfound (method, "max"))
    {
    } else
        Rcpp::stop ("method not found for rcpp_exact_merge");

    Rcpp::IntegerVector res;
    return res;
}
